<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Working with Pipelines :: Platform Foundation Bootcamp - RHOAI</title>
    <link rel="canonical" href="https://redhat-ai-services.github.io/rhoai-platform-foundation-bootcamp-instructions/modules/42_working_with_pipelines.html">
    <meta name="generator" content="Antora 3.1.14">
<link rel="stylesheet" href="../_/css/site.css"><link rel="stylesheet" href="../_/css/site-extra.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<meta name="robots" content="all">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="https://demo.redhat.com/images/favicon.ico" type="image/x-icon">
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar"  style="background-color: #131313 !important;">
    <div class="navbar-brand">
      <div style="display: flex; flex-direction:row; padding: 12px 32px; gap: 16px;">
     </div>
      <div class="navbar-item site-title" style="color: #fff !important;flex: 1;">Platform Foundation Bootcamp - RHOAI</div>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="modules" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title" style="display: none;"><a href="index.html" class=" query-params-link">Navigation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="01_welcome.html">Welcome and Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05_environment_provisioning.html">Environment Provisioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">AI-Accelerator</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="20_ai-accelerator_review.html">Project Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07_installation.html">Bootstrap Installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="30_gitops_env_setup_dev_prod.html">Setup Dev &amp; Prod Environments</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">RHOAI Administration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="32_dashboard_configuration.html">RHOAI Dashboard Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Notebooks</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="31_custom_notebook.html">Custom Notebook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09_remote_connect_notebook.html">Connect to Workbench Kernel</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Train, Store (S3), Deploy</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="33_model_training_car.html">Model Training</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="34_using_s3_storage.html">Using S3 Storage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="36_deploy_model.html">Deploy Model</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Science Pipelines</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="40_setup_pipeline_server.html">Setup Pipeline Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="41_introduction_to_kfp_pipelines.html">KFP Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kfp_elyra_differences.html">Comparison between Elyra and KFP</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="build_custom_runtime_image.html">Custom Runtime Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction_to_elyra_pipelines.html">Elyra Pipelines</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="42_working_with_pipelines.html">Working with Pipelines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="43_custom_runtime_image.html">Advanced Pipeline Customization</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Distributed Training</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="50_distributed_training.html">Ray Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Large Language Model [LLM]</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="60_llm_explore.html">Explore LLMs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="70_rag_llm.html">RAG with LLM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="composer_ai.html">Composer AI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Monitoring Data Science Models</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="80_trustyai_overview.html">TrustyAI Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="81_llm_evaluation.html">Evaluating Large Language Models</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Disconnected Environment</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="disconnected_install.html">RHOAI on Disconnected Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">GPU as a Service</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="90_environment_provisioning.html">Provisioning a GPU Environment with NVIDIA A10G Tensor Core GPU</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="91_gpu_as_a_service_intro.html">Introduction: GPU as a Service with GPU slicing and Kueue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="92_nvidia_gpu_operator.html">Configuring NVIDIA GPU Time-Slicing on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="93_kueue_setup.html">Red Hat build of Kueue Operator Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="94_kueue_gpu_pricing_tier.html">Implementing GPU Pricing Tiers with Kueue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="95_kueue_fair_sharing.html">Advanced GPU Quota Management and Preemption with Kueue</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Model-as-a-Service</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="100_maas_intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="101_maas_bootstrap.html">Environment Bootstrap</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="102_maas_as_developer.html">Using MaaS as Developer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="103_maas_as_platform_engineer.html">Configure a new model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="104_maas_monitor.html">Monitor usage</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Agentic AI with Llama Stack</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="97_agentic_ai_llama_stack_introduction.html">Introduction &amp; Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="98_agentic_ai_llama_stack_notebook_agents.html">Agentic AI Agents with Llama Stack Clients</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="99_agentic_ai_llama_stack_playground.html">Llama Stack Playground</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#99_useful_tips.adoc">Useful Tips</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#97_syncing_fork.adoc">Syncing Forked Project</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Navigation</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="01_welcome.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li>Data Science Pipelines</li>
    <li><a href="42_working_with_pipelines.html">Working with Pipelines</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Working with Pipelines</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this module we will be working with pipelines. We will be creating a pipeline that will train a model and then deploy it to a serving runtime.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_develop_a_kfp_pipeline_to_retrain_a_model"><a class="anchor" href="#_develop_a_kfp_pipeline_to_retrain_a_model"></a>Develop a KFP pipeline to retrain a model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the parasol-insurance repository, there is a python notebook that re-trains a model: <a href="https://github.com/rh-aiservices-bu/parasol-insurance/blob/dev/lab-materials/04/04-03-model-retraining.ipynb">04-03-model-retraining.ipynb</a>. We will be using this notebook to create a pipeline that will retrain the model.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In RHOAI, open the <strong>standard-workbench</strong>.</p>
</li>
<li>
<p>Create a new notebook and name it <code>model-retraining-pipeline</code>.</p>
</li>
<li>
<p>Start the notebook with a cell to import the packages neccesary to work with <code>kfp</code> pipelines sdk:</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">import kfp.compiler
from kfp import dsl</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Add a cell to define the kubeflow endpoint, and the image that will be used to create containers that will execute each task:</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">KUBEFLOW_ENDPOINT = 'https://ds-pipeline-dspa.parasol-insurance.svc.cluster.local:8443'
PYTHON_IMAGE = 'image-registry.openshift-image-registry.svc:5000/openshift/python:latest'</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Add a cell to define the task that will download the dataset (see the <code>retrieve_dataset</code> function defined at  <a href="https://github.com/rh-aiservices-bu/parasol-insurance/blob/dev/lab-materials/04/04-03-model-retraining.ipynb">04-03-model-retraining.ipynb</a>)</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">@dsl.component(
    base_image=PYTHON_IMAGE,
    packages_to_install=["requests", "zipp"],
)
def download_data(dataset_type: str,
                  datasets: dsl.Output[dsl.Dataset]):
    import requests
    import zipfile

    URL = f"https://rhods-public.s3.amazonaws.com/sample-data/accident-data/accident-{dataset_type}.zip"

    print("Downloading file...")
    response = requests.get(URL, stream=True)
    block_size = 1024
    with open(f'./accident-{dataset_type}.zip', 'wb') as f:
        for data in response.iter_content(block_size):
            f.write(data)

    print("Unzipping file...")
    with zipfile.ZipFile(f'./accident-{dataset_type}.zip', 'r') as zip_ref:
        zip_ref.extractall(path=datasets.path)
    print("Done!")</code></pre>
</div>
</div>
</div>
</details>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice the output dataset parameter (<code>datasets: dsl.Output[dsl.Dataset]</code>), and how we use the path of such dataset to unzip the contents of the downloaded dataset.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a cell to define the pipeline, and use the previously defined task.</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">@kfp.dsl.pipeline(
    name="Accident Detection",
)
def accident_detection_pipeline(model_obc: str = "accident-detection"):
    download_data(dataset_type="sample")</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Create a cell to connect to the <code>KUBEFLOW_ENDPOINT</code>, and create your pipeline run:</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">print(f"Connecting to kfp: {KUBEFLOW_ENDPOINT}")
import os

bearer_token = "sha256~P0wEh46fxWa4uzPKR-b3fhcnsyXvCju4GovRd2YNNKM"

sa_ca_cert = "/run/secrets/kubernetes.io/serviceaccount/service-ca.crt"
if os.path.isfile(sa_ca_cert) and "svc" in KUBEFLOW_ENDPOINT:
    ssl_ca_cert = sa_ca_cert
else:
    ssl_ca_cert = None

client = kfp.Client(
    host=KUBEFLOW_ENDPOINT,
    existing_token=bearer_token,
    ssl_ca_cert=ssl_ca_cert,
)
result = client.create_run_from_pipeline_func(
    accident_detection_pipeline, arguments={}, experiment_name="accident-detection")</code></pre>
</div>
</div>
</div>
</details>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Provide your own token, you can find the token in the OpenShift Web Console by clicking on your username in the top right corner and selecting <code>Copy Login Command</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save and run your notebook.</p>
</li>
<li>
<p>Validate that the pipeline is running, using the RHOAI dashboard, navigate to the <strong>pipeline runs</strong> of the <strong>parasol-insurance</strong> data science project: You should find a run with a name starting with <strong>accident-detection</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/acc_detection_run_1.png" alt="acc detection run 1">
</div>
</div>
</li>
<li>
<p>Create a cell to train the model, organize this cell to appear before the cell that defines the pipeline (<code>@kfp.dsl.pipeline</code>). The contents of this cell were crafted after from a combination of functions from <a href="https://github.com/rh-aiservices-bu/parasol-insurance/blob/dev/lab-materials/04/04-03-model-retraining.ipynb">04-03-model-retraining.ipynb</a>; we recommend you to compare this cell with the original notebook contents:</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">@dsl.component(
    base_image=PYTHON_IMAGE,
    packages_to_install=["ultralytics", "opencv-contrib-python-headless"],
)
def train_model(datasets: dsl.Input[dsl.Dataset],
                model_onnx: dsl.Output[dsl.Model]):
    import os
    import shutil
    import datetime
    from ultralytics import YOLO

    print("setting the symlink for the datasets")
    os.symlink(datasets.path, "/opt/app-root/src/datasets")

    # Load model
    print("using a base model to start the training")
    model = YOLO('yolov8m.pt')  # load a pretrained model (recommended for training)
    print("training the model")
    model.train(data=f'{datasets.path}/accident-sample/data.yaml',
                          epochs=1, imgsz=640, batch=2)

    print("saving the file as onnx")

    # create runs/detect/train/weights/best.onnx
    YOLO("/opt/app-root/src/runs/detect/train/weights/best.pt").export(format="onnx")

    # save runs/detect/train/weights/best.onnx as {model_onnx.path}/accident-detection_{timestamp}.onnx
    timestamp = datetime.datetime.now().strftime("%Y%m%d%H%M")
    os.makedirs(model_onnx.path, exist_ok=True)
    shutil.copy('/opt/app-root/src/runs/detect/train/weights/best.onnx',
                f'{model_onnx.path}/accident-detection_{timestamp}.onnx')</code></pre>
</div>
</div>
</div>
</details>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice here the use of the <code>shutil</code> package to copy from the default output directory from the YOLO package to the output path of our <code>model_onnx</code> output parameter.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the <code>train_model</code> task to the pipeline:</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">@kfp.dsl.pipeline(
    name="Accident Detection",
)
def accident_detection_pipeline(model_obc: str = "accident-detection"):
    download_data_task = download_data(dataset_type="sample")
    train_model(datasets=download_data_task.output)</code></pre>
</div>
</div>
</div>
</details>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice how we use the output of the <code>download_data</code> task as the input of the <code>train_model</code> task.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save and run your notebook.</p>
</li>
<li>
<p>Validate that the pipeline is running, using the RHOAI dashboard, navigate to the <strong>Experiments</strong> &#8594; <strong>Experiments and runs</strong>: You should find a run with a name starting with <strong>accident-detection</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/acc_detect_run_2.png" alt="acc detect run 2">
</div>
</div>
</li>
<li>
<p>Create a cell to upload the model to s3 using the <code>boto3</code> package, organize this cell to appear before the cell that defines the pipeline (<code>@kfp.dsl.pipeline</code>):</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">@dsl.component(
    base_image=PYTHON_IMAGE,
    packages_to_install=["boto3"],
)
def upload_to_s3(model_onnx: dsl.Input[dsl.Model]):
    import os
    import boto3
    from botocore.client import Config

    print("configuring s3 instance")
    # Configuration
    minio_url = "http://minio.object-datastore.svc.cluster.local:9000"
    access_key = "minio"
    secret_key = "minio123"

    # Setting up the MinIO client
    s3 = boto3.client(
        's3',
        endpoint_url=minio_url,
        aws_access_key_id=access_key,
        aws_secret_access_key=secret_key,
        config=Config(signature_version='s3v4'),
    )

    for (dirpath, dirnames, filenames) in os.walk(model_onnx.path):
        for file in filenames:
            print(f"uploading file {dirpath}/{file}")
            s3.upload_file(f"{dirpath}/{file}", "models",
                           f"accident_model/{file}")</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Add the <code>upload_to_s3</code> task to the pipeline.</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">@kfp.dsl.pipeline(
    name="Accident Detection",
)
def accident_detection_pipeline(model_obc: str = "accident-detection"):
    download_data_task = download_data(dataset_type="sample")
    train_model_task = train_model(datasets=download_data_task.output)
    upload_to_s3(model_onnx=train_model_task.outputs["model_onnx"])</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Save and run your notebook.</p>
</li>
<li>
<p>Validate that the pipeline is running, using the RHOAI dashboard, navigate to <strong>Experiments</strong> &#8594; <strong>Experiments and runs</strong>: You should find a run with a name starting with <strong>accident-detection</strong></p>
<div class="imageblock">
<div class="content">
<img src="_images/accident_detection_pipeline.png" alt="accident detection pipeline">
</div>
</div>
</li>
<li>
<p>Validate that the model is uploaded to the s3 bucket, by navigating to the s3 bucket in the minio console.</p>
<div class="imageblock bordershadow">
<div class="content">
<img src="_images/minio_s3_bucket.png" alt="minio s3 bucket">
</div>
</div>
</li>
<li>
<p>Validate the resulting script: The script should look like this: <a href="https://github.com/redhat-ai-services/ai-accelerator-bootcamp/blob/main/source_code/40_pipelines/train-car-rekon.py">train-car-rekon.py</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_pipeline_to_train_a_model"><a class="anchor" href="#_create_a_pipeline_to_train_a_model"></a>Create a pipeline to train a model</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <code>model-training-pipeline</code> directory in the <code>parasol-insurance</code> tenants directory.</p>
</li>
<li>
<p>Create the <code>base</code> and <code>overlays</code> directories in the <code>model-training-pipeline</code> directory.</p>
</li>
<li>
<p>In the <code>base</code> directory, create a <code>kustomization.yaml</code> file with the following content:</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: parasol-insurance

resources:
  - model-retrain-imagestream.yaml
  - model-retrain-pipeline.yaml
  - model-retrain-pipelinerun.yaml
  - execute-kfp-task.yaml</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Create file <code>tenants/parasol-insurance/model-training-pipeline/base/model-retrain-imagestream.yaml</code>.</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="title">tenants/parasol-insurance/model-training-pipeline/base/model-retrain-imagestream.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  name: model-retrain</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Create file <code>tenants/parasol-insurance/model-training-pipeline/base/model-retrain-pipeline.yaml</code>.</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="title">tenants/parasol-insurance/model-training-pipeline/base/model-retrain-pipeline.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: model-retrain
spec:
  params:
    - default: 'https://github.com/redhat-ai-services/ai-accelerator-bootcamp.git'
      description: Repo URL
      name: GIT_URL
      type: string
    - default: 'source_code/40_pipelines'
      description: Repo URL
      name: CONTEXT
      type: string
    - default: 'train-car-rekon.py'
      name: PIPELINE_SCRIPT
      type: string
    - default: main
      name: GIT_REVISION
      type: string
    - default: 3.11-ubi9
      name: PYTHON_IMAGE
      type: string
    - default: 'image-registry.openshift-image-registry.svc:5000/parasol-insurance/model-retrain'
      name: TARGET_IMAGE
      type: string
    - default: 'https://ds-pipeline-dspa.parasol-insurance.svc.cluster.local:8443'
      name: KUBEFLOW_ENDPOINT
      type: string
  tasks:
    - name: git-clone
      params:
        - name: URL
          value: $(params.GIT_URL)
        - name: REVISION
          value: $(params.GIT_REVISION)
      taskRef:
        resolver: cluster
        params:
          - name: kind
            value: task
          - name: name
            value: git-clone
          - name: namespace
            value: openshift-pipelines
      workspaces:
        - name: output
          workspace: source
    - name: s2i-python
      params:
        - name: VERSION
          value: $(params.PYTHON_IMAGE)
        - name: CONTEXT
          value: $(params.CONTEXT)
        - name: IMAGE
          value: $(params.TARGET_IMAGE)
      runAfter:
        - git-clone
      taskRef:
        resolver: cluster
        params:
          - name: kind
            value: task
          - name: name
            value: s2i-python
          - name: namespace
            value: openshift-pipelines
      workspaces:
        - name: source
          workspace: source
    - name: execute-kubeflow-pipeline
      params:
        - name: IMAGE
          value: $(params.TARGET_IMAGE)
        - name: TAG
          value: latest
        - name: SCRIPT
          value: $(params.PIPELINE_SCRIPT)
        - name: KUBEFLOW_ENDPOINT
          value: $(params.KUBEFLOW_ENDPOINT)
      runAfter:
        - s2i-python
      taskRef:
        kind: Task
        name: execute-kubeflow-pipeline
  workspaces:
    - name: source</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Create file <code>tenants/parasol-insurance/model-training-pipeline/base/model-retrain-pipelinerun.yaml</code>.</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="title">tenants/parasol-insurance/model-training-pipeline/base/model-retrain-pipelinerun.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: model-retrain-init
  annotations:
    argocd.argoproj.io/sync-wave: "10"
spec:
  pipelineRef:
    name: model-retrain
  taskRunTemplate:
    serviceAccountName: pipeline
  timeouts:
    pipeline: 1h0m0s
  workspaces:
  - name: source
    volumeClaimTemplate:
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        volumeMode: Filesystem</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Create file <code>tenants/parasol-insurance/model-training-pipeline/base/execute-kfp-task.yaml</code>.</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="title">tenants/parasol-insurance/model-training-pipeline/base/execute-kfp-task.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: execute-kubeflow-pipeline
spec:
  description: &gt;-
    This task will execute a python script, triggering a kubeflow pipeline
  params:
    - name: IMAGE
      description: The image used to execute the script
      type: string
    - name: TAG
      description: The tag for the image
      type: string
      default: "latest"
    - name: SCRIPT
      description: The name of the script to be executed
    - name: KUBEFLOW_ENDPOINT
      description: The endpoint URL for Kubeflow
      default: "https://ds-pipeline-dspa:8443"
  steps:
    - name: execute-python
      image: $(inputs.params.IMAGE):$(inputs.params.TAG)
      env:
        - name: KUBEFLOW_ENDPOINT
          value: $(inputs.params.KUBEFLOW_ENDPOINT)
      script: |
        python $(inputs.params.SCRIPT)</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>In the <code>overlays</code> directory, create a <code>parasol-insurance-dev</code> directory.</p>
</li>
<li>
<p>In the <code>parasol-insurance-dev</code> directory, create a <code>kustomization.yaml</code> file.</p>
<details>
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock console-input">
<div class="title">tenants/parasol-insurance/model-training-pipeline/overlays/parasol-insurance-dev/kustomization.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base</code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Commit and push the changes to the Git repository.</p>
</li>
<li>
<p>Wait for ArgoCD to sync the changes.</p>
</li>
<li>
<p>Navigate to the OpenShift console, and validate that the <code>model-retrain</code> pipeline is available in the <code>parasol-insurance</code> namespace.</p>
</li>
<li>
<p>Click on the <code>model-retrain</code> pipeline, and validate that there is a pipeline run, wait the pipeline run to complete</p>
</li>
<li>
<p>Navigate to the RHOAI dashboard &#8594; <strong>Experiments</strong> &#8594; <strong>Experiments and runs</strong>: You should find a run with a name starting with <strong>accident-detection</strong></p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Validate your code against <a href="https://github.com/redhat-ai-services/ai-accelerator-qa/pull/new/42_working_with_pipeline">Branch for model_retrain pipeline config</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>model-retrain-pipeline.yaml</code> refers previously mentioned <a href="https://github.com/redhat-ai-services/ai-accelerator-bootcamp/blob/main/source_code/40_pipelines/train-car-rekon.py#L99">train-car-recon.py</a>, which uploads model file to S3 and expects that the bucket named <code>models</code> already exists. You can verify this in MinIO web interface and if necessary create missing bucket from there.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_experiments"><a class="anchor" href="#_experiments"></a>Experiments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A pipeline experiment is a workspace where you can try different configurations of your pipelines. You can use experiments to organize your runs into logical groups.</p>
</div>
<div class="sect2">
<h3 id="_experiments_and_runs"><a class="anchor" href="#_experiments_and_runs"></a>Experiments and Runs</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to RHOAI Dasboard, click on <strong>Experiments</strong> &gt; <strong>Experiments and Runs</strong>. Validate that new experiment <code>accident_detection</code> is created</p>
<div class="imageblock bordershadow">
<div class="content">
<img src="_images/experiments_runs.png" alt="experiments runs">
</div>
</div>
</li>
<li>
<p>Click on the experiment <code>accident_detection</code> to view pipeline runs.</p>
<div class="imageblock bordershadow">
<div class="content">
<img src="_images/pipeline_run.png" alt="pipeline run">
</div>
</div>
</li>
<li>
<p>Click on each pipeline run to view more details.</p>
</li>
<li>
<p>We can schedule periodic pipeline runs for an experiment. Click on 'Schedules'. Click on 'Create Schedule'. Please fill following details:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Experiment:</strong> We can choose an existing Experiment or create a new Experiment.</p>
</li>
<li>
<p><strong>Name:</strong> Name for the schedule</p>
</li>
<li>
<p><strong>Trigger Type:</strong> Periodic</p>
</li>
<li>
<p><strong>Run Every:</strong> 1 hour</p>
</li>
<li>
<p><strong>Start Date:</strong> Start date for the schedule</p>
</li>
<li>
<p><strong>End Date:</strong> End Date for the schedule</p>
</li>
<li>
<p><strong>Pipeline:</strong> Name of the pipeline</p>
</li>
<li>
<p><strong>Pipeline version:</strong> Version of the pipeline</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="imageblock bordershadow">
<div class="content">
<img src="_images/schedule_run.png" alt="schedule run">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_executions"><a class="anchor" href="#_executions"></a>Executions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On Executions page, you can view the execution details of each pipeline task execution, such as its name, status, unique ID, and execution type.</p>
</div>
<div class="imageblock bordershadow">
<div class="content">
<img src="_images/executions.png" alt="executions">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_artifacts"><a class="anchor" href="#_artifacts"></a>Artifacts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On Artifacts page, you can view the pipeline artifacts. It helps you to evaluate the performance of your pipeline runs.</p>
</div>
<div class="imageblock bordershadow">
<div class="content">
<img src="_images/artifacts.png" alt="artifacts">
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a href="https://demo.redhat.com" target="_blank" class="poweredBy"><p>Powered by</p><div class="labInfo_poweredBy" style="display: block; width: 260px;"><svg class="labInfo_poweredByLogo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1508.5 178.739"><g fill="#111"><path d="M316.6 63.2v-56H342a21.279 21.279 0 0 1 7.8 1.3 18.111 18.111 0 0 1 5.9 3.5 15.577 15.577 0 0 1 5 11.8 15.051 15.051 0 0 1-3.1 9.5 16.836 16.836 0 0 1-8.4 5.8l12.5 24.1h-9.3l-11.6-23H325v23Zm24.7-48.6H325v18.7h16.3q5.25 0 8.1-2.7a8.7 8.7 0 0 0 2.8-6.6 8.7 8.7 0 0 0-2.8-6.6c-1.8-1.9-4.5-2.8-8.1-2.8ZM364.1 42.8a20.674 20.674 0 0 1 1.6-8.2 20.288 20.288 0 0 1 4.3-6.7 19.92 19.92 0 0 1 6.5-4.5 19.718 19.718 0 0 1 8-1.6 18.463 18.463 0 0 1 7.8 1.6 18.677 18.677 0 0 1 6.2 4.5 20.927 20.927 0 0 1 4.1 6.8 23.2 23.2 0 0 1 1.5 8.4v2.3H372a13.822 13.822 0 0 0 4.6 8.4 13.6 13.6 0 0 0 9.1 3.3 15.553 15.553 0 0 0 5.7-1 12.858 12.858 0 0 0 4.6-2.6l5.1 5a25.983 25.983 0 0 1-7.4 4.1 24.69 24.69 0 0 1-8.4 1.3 21.306 21.306 0 0 1-8.4-1.6 22.763 22.763 0 0 1-6.8-4.4 20.788 20.788 0 0 1-4.5-6.7 23.2 23.2 0 0 1-1.5-8.4Zm20.2-14.2a11.527 11.527 0 0 0-8 3 13.046 13.046 0 0 0-4.2 7.8h24.2a13.091 13.091 0 0 0-4.2-7.8 11.106 11.106 0 0 0-7.8-3ZM443.1 63.2v-3.8a19.448 19.448 0 0 1-5.8 3.3 18.924 18.924 0 0 1-6.7 1.2 19.824 19.824 0 0 1-14.6-6.1 22.268 22.268 0 0 1-4.4-6.7 21.812 21.812 0 0 1 0-16.4A20.534 20.534 0 0 1 416 28a19.335 19.335 0 0 1 6.6-4.5 20.334 20.334 0 0 1 8.2-1.6 20.7 20.7 0 0 1 6.6 1 19.415 19.415 0 0 1 5.7 3V7.2l8-1.8v57.8Zm-25.2-20.4a13.718 13.718 0 0 0 4 10.1 13.45 13.45 0 0 0 9.8 4.1 14.956 14.956 0 0 0 6.4-1.3 15.954 15.954 0 0 0 4.9-3.6V33.6a14.988 14.988 0 0 0-4.9-3.5 15.271 15.271 0 0 0-6.4-1.3 13.423 13.423 0 0 0-9.9 4 13.806 13.806 0 0 0-3.9 10ZM478.1 63.2v-56h8.4v24h29.8v-24h8.4v56h-8.4V38.8h-29.8v24.4ZM547.2 64a16.483 16.483 0 0 1-10.8-3.5 11.037 11.037 0 0 1-4.2-8.9 10.375 10.375 0 0 1 4.7-9.2 20.76 20.76 0 0 1 11.8-3.2 27.841 27.841 0 0 1 5.8.6 27.374 27.374 0 0 1 5.3 1.6v-4.3a8.143 8.143 0 0 0-2.6-6.5 11.452 11.452 0 0 0-7.4-2.2 20.788 20.788 0 0 0-6 .9 34.616 34.616 0 0 0-6.6 2.6l-3-6a54.169 54.169 0 0 1 8.4-3.1 33.18 33.18 0 0 1 8.3-1.1c5.2 0 9.3 1.3 12.2 3.8s4.4 6.1 4.4 10.8v27h-7.8v-3.5a19.441 19.441 0 0 1-5.8 3.2 23.54 23.54 0 0 1-6.7 1Zm-7.3-12.6a5.646 5.646 0 0 0 2.6 4.8 11.193 11.193 0 0 0 6.6 1.8 16.256 16.256 0 0 0 5.9-1 14.449 14.449 0 0 0 4.9-2.9V47a19.778 19.778 0 0 0-4.8-1.8 24.933 24.933 0 0 0-5.7-.6 11.859 11.859 0 0 0-6.8 1.8 5.728 5.728 0 0 0-2.7 5ZM580.6 53.2v-24H572v-6.7h8.6V12.1l7.9-1.9v12.3h12v6.7h-12v22.1a5.94 5.94 0 0 0 1.4 4.4c.9.9 2.5 1.3 4.6 1.3a23.637 23.637 0 0 0 3-.2 10.857 10.857 0 0 0 2.8-.8v6.7a19.28 19.28 0 0 1-3.8.9 27.484 27.484 0 0 1-3.8.3c-3.9 0-7-.9-9-2.8-2-1.7-3.1-4.4-3.1-7.9Z"></path></g><path d="M127 90.2c12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4L149.8 37c-1.7-7.1-3.2-10.3-15.7-16.6-9.7-5-30.8-13.1-37.1-13.1-5.8 0-7.5 7.5-14.4 7.5-6.7 0-11.6-5.6-17.9-5.6-6 0-9.9 4.1-12.9 12.5 0 0-8.4 23.7-9.5 27.2a4.216 4.216 0 0 0-.3 1.9c0 9.2 36.3 39.4 85 39.4Zm32.5-11.4c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3C21.8 58.8 0 61.8 0 81c0 31.5 74.6 70.3 133.7 70.3 45.3 0 56.7-20.5 56.7-36.6-.1-12.8-11-27.3-30.9-35.9Z" fill="#e00"></path><path d="M159.5 78.8c1.7 8.2 1.7 9.1 1.7 10.1 0 14-15.7 21.8-36.4 21.8-46.8 0-87.7-27.4-87.7-45.5a17.535 17.535 0 0 1 1.5-7.3l3.7-9.1a4.877 4.877 0 0 0-.3 2c0 9.2 36.3 39.4 85 39.4 12.5 0 30.6-2.6 30.6-17.5a12.678 12.678 0 0 0-.3-3.4Z"></path><path d="M253.5 158.7a2.22 2.22 0 0 1-2.2-2.2V2.2a2.2 2.2 0 0 1 4.4 0v154.2a2.242 2.242 0 0 1-2.2 2.3Z" fill="#111"></path><text data-name="Demo Platform" transform="translate(1186 149)" fill="#111" font-size="82" font-family="'RedHatDisplay', 'Overpass', overpass, helvetica, arial, sans-serif" font-weight="700"><tspan x="-877.892" y="0">Demo Platform</tspan></text></svg></div></a>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
